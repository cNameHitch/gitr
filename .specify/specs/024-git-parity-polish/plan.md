# Implementation Plan: Git Behavioral Parity Polish

**Branch**: `023-git-parity-polish` | **Date**: 2026-02-09 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `.specify/specs/024-git-parity-polish/spec.md`

## Summary

Address 42 identified behavioral differences between gitr and git to achieve output-identical parity. The fixes span 5 categories: core command bugs (P0), missing flags/options (P1), formatting/cosmetic differences (P2), exit code mismatches (P2), and config/init gaps (P3). All changes target existing crates — no new crates are introduced. The approach groups fixes by affected command/crate to minimize blast radius, with each fix accompanied by a dedicated E2E interop test.

## Technical Context

**Language/Version**: Rust 1.75+ (Cargo workspace, 19 crates)
**Primary Dependencies**: `bstr` 1, `sha1`/`sha2` 0.10, `flate2` 1, `memmap2` 0.9, `crc32fast` 1, `clap` 4, `thiserror` 2 / `anyhow` 1, `rayon` 1, `chrono` (date formatting)
**Storage**: Git on-disk format (loose objects, packfiles v2, refs, index, config) — all file-based
**Testing**: `cargo test --workspace`, `tempfile` 3 for test isolation, E2E interop tests via `std::process::Command`
**Target Platform**: macOS / Linux (CLI binary)
**Project Type**: Cargo workspace (16 library crates + 1 CLI binary crate)
**Performance Goals**: Byte-identical output to C git for all 42 fixed behaviors
**Constraints**: No new crate dependencies, no new crates, zero regressions in existing tests
**Scale/Scope**: 42 functional requirements, ~20 files modified across 5 crates

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Safety-First | ✅ PASS | All changes use `Result<T, E>`. No `unsafe` introduced. Pathspec disambiguation uses fallible resolution. |
| II. C-Compatibility | ✅ PASS | This is the primary goal — closing 42 remaining behavioral gaps to achieve byte-identical output. |
| III. Modular Crates | ✅ PASS | All changes go into existing crates (git-cli, git-revwalk, git-utils, git-config, git-repository). No new crates. No circular deps. |
| IV. Trait-Based Abstraction | ✅ PASS | No new trait boundaries needed. Existing command dispatch patterns are preserved. |
| V. Test-Driven | ✅ PASS | Every fix includes a dedicated E2E interop test comparing gitr output against C git. Uses established common test harness. |
| Error Handling | ✅ PASS | `thiserror` in library crates, `anyhow` only in CLI. Exit code mapping uses clap error handler override. |
| Performance | ✅ PASS | No performance-impacting changes. Pathspec disambiguation adds one revision-resolve attempt per arg (negligible). |
| Byte String Handling | ✅ PASS | Path arguments use `&str`/`String` from clap. Git paths remain `BString`/`bstr` internally. |
| Serialization | ✅ PASS | No on-disk format changes. All fixes are behavioral (output formatting, argument parsing, exit codes). |

**Gate result**: ALL PASS — no violations to justify.

**Post-Phase 1 Re-Check**: All principles still pass. The clap error handler override (FR-038) is a standard clap customization pattern, not a safety concern. Date formatting changes use chrono's existing `%e` vs `%-e` specifiers. System config loading uses platform-conditional paths (`#[cfg(target_os = "macos")]`).

## Project Structure

### Documentation (this feature)

```text
.specify/specs/024-git-parity-polish/
├── plan.md              # This file
├── spec.md              # Feature specification — 42 functional requirements
├── research.md          # Phase 0 output — 14 research decisions
├── data-model.md        # Phase 1 output — 8 entity modifications
├── quickstart.md        # Phase 1 output — build/test/verify guide
├── contracts/
│   ├── pathspec-disambiguation.md   # Pathspec vs revision argument parsing contract
│   ├── format-string-parity.md      # Format placeholder completeness contract
│   ├── exit-code-mapping.md         # Exit code behavior contract
│   └── config-cascade.md            # Config loading order contract
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
crates/
├── git-cli/src/
│   ├── main.rs                    # FR-038: clap error handler for exit code 128
│   ├── commands/
│   │   ├── diff.rs                # FR-001/002: pathspec disambiguation, hunk header fix
│   │   ├── reset.rs               # FR-003: bare pathspec support
│   │   ├── check_ignore.rs        # FR-004: directory pattern matching
│   │   ├── log.rs                 # FR-005/013/014/023/026/027: date filter, -N, --decorate, date pad, stat blank line, graph
│   │   ├── init.rs                # FR-006/032/041/042: mkdir -p, symlink resolve, macOS config, sample hooks
│   │   ├── show.rs                # FR-007/008/010/011/012: --stat suppress, merge header, oneline hash, raw indent, format strings
│   │   ├── commit_tree.rs         # FR-009: stdin message reading (already works — verify)
│   │   ├── branch.rs              # FR-015/036: -v verbose, exit code 1
│   │   ├── tag.rs                 # FR-016: -n annotation display
│   │   ├── ls_tree.rs             # FR-017: -l long format with sizes
│   │   ├── rev_parse.rs           # FR-018/019: --abbrev-ref, --short optional value
│   │   ├── config.rs              # FR-020/039/040: --local, system config, --show-origin
│   │   ├── format_patch.rs        # FR-021/033: --stdout, filename prefix
│   │   ├── remote.rs              # FR-022: show subcommand
│   │   ├── clean.rs               # FR-028/029: sorted output, no dir files without -d
│   │   ├── commit.rs              # FR-030: summary line with insertions/deletions
│   │   ├── stash.rs               # FR-031: pop status output
│   │   ├── shortlog.rs            # FR-034: oldest-first ordering
│   │   ├── show_ref.rs            # FR-035: exit code 1 for missing refs
│   │   └── checkout.rs            # FR-037: exit code 1 for missing refs
│   └── tests/
│       ├── common/mod.rs          # Shared test harness (existing)
│       └── parity_polish_tests.rs # NEW: All 42 interop tests for this feature
├── git-revwalk/src/
│   └── pretty.rs                  # FR-012/024: format string completeness, email date
├── git-utils/src/
│   └── date.rs                    # FR-023/024: date padding fixes (%-e vs %e)
├── git-config/src/
│   └── lib.rs                     # FR-039: system config file discovery
└── git-repository/src/
    └── lib.rs                     # FR-041/042: macOS init config, sample hooks
```

**Structure Decision**: Existing Cargo workspace structure. All changes modify existing files. The only new file is `parity_polish_tests.rs` for the 42+ interop tests for this feature.

## Complexity Tracking

> No constitution violations — table not needed.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| (none) | — | — |

## Implementation Phases

### Phase 1: Core Command Fixes — Pathspec Disambiguation (P0, FR-001/002/003)

**Goal**: Make `diff` and `reset` accept bare pathspecs without `--` separator, and fix new-file hunk headers.

**Changes**:

1. **git-cli/src/commands/diff.rs**:
   - Modify `parse_diff_args()` to implement git's disambiguation: for each non-flag arg before `--`, attempt `resolve_revision()` — if it fails and the path exists on disk, treat as pathspec
   - Fix hunk header generation for new files: when diffing against `/dev/null`, start line must be 0 (`@@ -0,0 +1,N @@` not `@@ -1,0 +1,N @@`)

2. **git-cli/src/commands/reset.rs**:
   - Modify argument parsing to accept `reset file.txt` (bare pathspec) and `reset HEAD file.txt` (rev + pathspec) without `--`
   - Use same disambiguation pattern as diff: try as revision first, fall back to pathspec

3. **Tests**: E2E tests for bare pathspec diff, `diff --cached` hunk headers, bare pathspec reset

### Phase 2: Core Command Fixes — Log, Show, Init, Check-Ignore (P0, FR-004–012)

**Goal**: Fix remaining P0 functional bugs.

**Changes**:

1. **git-cli/src/commands/check_ignore.rs**: Fix directory pattern matching so `build/` matches both the directory and files within it
2. **git-cli/src/commands/log.rs**: Add `--since`/`--until` date filtering using author date comparison
3. **git-cli/src/commands/init.rs**: Create parent directories recursively (`std::fs::create_dir_all`) when target path doesn't exist
4. **git-cli/src/commands/show.rs**:
   - `--stat` must suppress full diff output
   - Add `Merge: <parent1> <parent2>` header for merge commits
   - `--format=oneline` outputs full 40-char hash
   - `--format=raw` indents message body with 4 spaces
5. **git-revwalk/src/pretty.rs**: Ensure all standard format placeholders are supported (`%d`, `%D` for decoration)

### Phase 3: Missing Flags (P1, FR-013–022)

**Goal**: Add commonly used flags that gitr currently rejects.

**Changes**:

1. **git-cli/src/commands/log.rs**: Accept `-N` shorthand (FR-013), `--decorate` flag (FR-014)
2. **git-cli/src/commands/branch.rs**: Accept `-v`/`--verbose` showing hash + subject (FR-015)
3. **git-cli/src/commands/tag.rs**: Accept `-n[num]` for annotation display (FR-016)
4. **git-cli/src/commands/ls_tree.rs**: Accept `-l`/`--long` for object sizes (FR-017)
5. **git-cli/src/commands/rev_parse.rs**: Accept `--abbrev-ref` (FR-018) and `--short` as optional-value flag (FR-019)
6. **git-cli/src/commands/config.rs**: Accept `--local` flag (FR-020)
7. **git-cli/src/commands/format_patch.rs**: Accept `--stdout` flag (FR-021)
8. **git-cli/src/commands/remote.rs**: Add `show` subcommand (FR-022)

### Phase 4: Output Formatting Fixes (P2, FR-023–034)

**Goal**: Achieve character-identical output formatting.

**Changes**:

1. **git-utils/src/date.rs**: Fix day-of-month padding — use `%-e` (no padding) for default format, `%-d` for email format (FR-023/024)
2. **git-cli/src/commands/diff.rs**: Fix `--stat` alignment to use minimal padding (FR-025)
3. **git-cli/src/commands/log.rs**: Add blank line between message and stat (FR-026), fix `--graph` compact notation (FR-027)
4. **git-cli/src/commands/clean.rs**: Sort output alphabetically (FR-028), exclude dir contents without `-d` (FR-029)
5. **git-cli/src/commands/commit.rs**: Add `N files changed, N insertions(+)` summary (FR-030)
6. **git-cli/src/commands/stash.rs**: Display full working tree status after pop (FR-031)
7. **git-cli/src/commands/init.rs**: Resolve symlinks in success message, add trailing `/` (FR-032)
8. **git-cli/src/commands/format_patch.rs**: Remove `./` prefix from filenames (FR-033)
9. **git-cli/src/commands/shortlog.rs**: Order commits oldest-first within each author (FR-034)

### Phase 5: Exit Codes and Config/Init (P2–P3, FR-035–042)

**Goal**: Fix exit code mismatches and platform-specific config behavior.

**Changes**:

1. **git-cli/src/commands/show_ref.rs**: Exit code 1 for nonexistent refs with `--verify` (FR-035)
2. **git-cli/src/commands/branch.rs**: Exit code 1 for `branch -d nonexistent` (FR-036)
3. **git-cli/src/commands/checkout.rs**: Exit code 1 for nonexistent refs (FR-037)
4. **git-cli/src/main.rs**: Override clap's error handler to exit with 128 instead of 2 (FR-038)
5. **git-config/src/lib.rs**: Add system config file discovery — macOS: `/Library/Developer/CommandLineTools/usr/share/git-core/gitconfig`, also `$(prefix)/etc/gitconfig` (FR-039)
6. **git-cli/src/commands/config.rs**: Add `--show-origin` prefix for single-key queries (FR-040)
7. **git-repository/src/lib.rs**: On macOS, set `core.ignorecase = true` and `core.precomposeunicode = true` during init (FR-041)
8. **git-repository/src/lib.rs**: Create standard sample hook files during init (FR-042)

### Phase 6: Regression Validation

**Goal**: Confirm zero regressions, all new tests pass.

**Changes**:

1. Run full `cargo test --workspace`
2. Run all new parity polish tests
3. Run existing parity tests and E2E workflow tests
4. Verify `cargo clippy --workspace` passes
