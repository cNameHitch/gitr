# Implementation Plan: End-to-End Git Interoperability Tests

**Branch**: `019-e2e-interop-tests` | **Date**: 2026-02-07 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/019-e2e-interop-tests/spec.md`

## Summary

Add a comprehensive end-to-end interoperability test suite that verifies gitr is a byte-compatible drop-in replacement for C git. The suite exercises multi-step workflows (init→add→commit→branch→merge), remote operations (clone/fetch/push over file:// transport), advanced operations (rebase, stash, cherry-pick), and edge cases (binary files, unicode paths, empty repos) — comparing every output, exit code, and on-disk repository state between gitr and C git. A shared test harness module eliminates the helper duplication across the 3 existing test files.

## Technical Context

**Language/Version**: Rust 1.75+
**Primary Dependencies**: `tempfile` (test isolation), `std::process::Command` (subprocess execution)
**Storage**: N/A (tests operate on temporary filesystem directories)
**Testing**: `cargo test --workspace` — standard Rust integration tests
**Target Platform**: Linux (CI), macOS (dev) — wherever C git 2.x is available
**Project Type**: Cargo workspace — tests added to `crates/git-cli/tests/`
**Performance Goals**: Full e2e suite completes in < 5 minutes on CI with parallel execution
**Constraints**: No network dependencies; all remote tests use `file://` local transport
**Scale/Scope**: 50+ new test cases across 4 new test files + 1 shared harness module

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Safety-First | PASS | Test code only; no `unsafe`, all fallible operations use `Result` or `.unwrap()` in test context (acceptable for tests) |
| II. C-Compatibility | PASS | This feature directly validates C-Compatibility — it is the test suite that enforces byte-identical output |
| III. Modular Crates | PASS | Tests live in `crates/git-cli/tests/` alongside existing tests; no new crates added |
| IV. Trait-Based Abstraction | N/A | No production traits involved; test-only code |
| V. Test-Driven | PASS | This feature IS the test infrastructure. Acceptance tests are defined in the spec. |

**Post-Phase 1 Re-check**: All gates still pass. The shared harness module is internal to `git-cli` tests and does not affect crate boundaries or public APIs.

No violations. Complexity Tracking table not needed.

## Project Structure

### Documentation (this feature)

```text
specs/019-e2e-interop-tests/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research decisions
├── data-model.md        # Test entity model
├── quickstart.md        # Developer guide for running/writing tests
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
crates/git-cli/tests/
├── common/
│   └── mod.rs                  # NEW — Shared test harness module
├── e2e_workflow_tests.rs       # NEW — Multi-step workflow interop tests
├── e2e_remote_tests.rs         # NEW — Clone/fetch/push/pull interop tests
├── e2e_advanced_tests.rs       # NEW — Rebase/stash/cherry-pick/tag interop tests
├── e2e_edge_case_tests.rs      # NEW — Binary/unicode/empty/nested edge case tests
├── plumbing_tests.rs           # EXISTING — Refactored to use common module
├── porcelain_tests.rs          # EXISTING — Refactored to use common module
└── history_tests.rs            # EXISTING — Refactored to use common module
```

**Structure Decision**: Integration tests remain in `crates/git-cli/tests/` following the existing pattern. A `common/mod.rs` module is added for shared utilities. No new crates, no changes to workspace structure. Existing test files are refactored to import from `common` instead of duplicating helpers.

## Implementation Phases

### Phase A: Shared Test Harness (Foundation)

Create `crates/git-cli/tests/common/mod.rs` with:

1. **Process runners**: `git()`, `gitr()`, `gitr_full()` with full environment pinning (author, committer, date, timezone, locale, config isolation)
2. **Comparison helpers**: `assert_output_eq()`, `assert_normalized_eq()`, `assert_exit_code_eq()`, `assert_repo_state_eq()`
3. **Repo setup helpers**: `setup_empty_repo()`, `setup_linear_history()`, `setup_branched_history()`, `setup_merge_conflict()`, `setup_bare_remote()`, `setup_binary_files()`, `setup_unicode_paths()`, `setup_nested_dirs()`
4. **Utility**: `gitr_bin()` path discovery, `CommandResult` struct, `fsck()` helper, incremental date helper for multi-commit scenarios

**Dependencies**: None (uses only `std` and `tempfile`)

### Phase B: Refactor Existing Tests

Update the 3 existing test files to `mod common; use common::*;` and remove their duplicated helper functions. This ensures all tests share the same harness and environment pinning.

Files affected:
- `plumbing_tests.rs` — remove ~55 lines of duplicated helpers
- `porcelain_tests.rs` — remove ~74 lines of duplicated helpers
- `history_tests.rs` — remove ~62 lines of duplicated helpers

**Validation**: `cargo test -p git-cli` must pass with zero regressions after refactor.

### Phase C: E2E Workflow Tests (P1)

`e2e_workflow_tests.rs` — covers User Stories 1, 2, and 8:

**Basic workflow interop** (~8 tests):
- `test_init_add_commit_status_cycle`: Full init→add→commit→status sequence, compare all outputs
- `test_gitr_init_cgit_operates`: Gitr creates repo, C git does add/commit/log successfully
- `test_cgit_init_gitr_operates`: C git creates repo, gitr does add/commit/log successfully
- `test_status_identical_output`: Clean and dirty repo status output matches exactly
- `test_diff_staged_and_unstaged`: Diff output matches for both staged and unstaged changes
- `test_multiple_commits_sequential`: 5 sequential commits, each with distinct content, all outputs match
- `test_add_multiple_files_and_directories`: Stage files in nested dirs, compare index state
- `test_commit_message_formats`: Short, multi-line, and special character commit messages

**Branching and merging interop** (~8 tests):
- `test_branch_create_list_delete_cycle`: Full branch lifecycle, compare outputs at each step
- `test_fast_forward_merge`: Branch, commit, merge (ff), compare refs and output
- `test_three_way_merge_no_conflict`: Divergent changes to different files, merge, compare tree
- `test_merge_conflict_markers`: Conflicting changes, compare conflict markers and index stage entries
- `test_checkout_and_switch_equivalence`: Both checkout and switch produce same result as C git
- `test_merge_commit_message`: Auto-generated merge commit message matches C git
- `test_branch_rename`: Rename branch, compare refs
- `test_detached_head_operations`: Checkout to detached HEAD, compare behavior

**Cross-tool compatibility** (~6 tests):
- `test_gitr_repo_passes_cgit_fsck`: Gitr creates repo with 3 commits, C git fsck passes
- `test_cgit_repo_passes_gitr_fsck`: C git creates repo, gitr fsck passes
- `test_alternating_commits_ping_pong`: Alternating gitr/C git commits, fsck after each
- `test_mixed_history_log_identical`: Log output identical for mixed-author repos
- `test_gitr_gc_cgit_fsck`: Gitr runs gc, C git fsck validates packfile
- `test_cgit_gc_gitr_operates`: C git runs gc, gitr can still read all objects

### Phase D: E2E Remote Tests (P2)

`e2e_remote_tests.rs` — covers User Story 5:

**Clone interop** (~4 tests):
- `test_gitr_clone_matches_cgit_clone`: Clone same bare repo with both, compare working tree and refs
- `test_gitr_clone_bare`: Clone --bare, compare structure
- `test_clone_preserves_all_refs`: Branches and tags all present after clone
- `test_clone_remote_config`: Remote config (origin URL, fetch refspec) matches

**Fetch/push interop** (~5 tests):
- `test_gitr_push_cgit_fetch`: Gitr pushes to bare, C git fetches, objects valid
- `test_cgit_push_gitr_fetch`: C git pushes to bare, gitr fetches, refs match
- `test_push_new_branch`: Push a new branch, verify it appears on remote
- `test_fetch_new_commits`: Fetch after remote has new commits, refs advance
- `test_pull_fast_forward`: Pull performs fast-forward, output and refs match

### Phase E: E2E Advanced Tests (P3)

`e2e_advanced_tests.rs` — covers User Story 6:

**Rebase** (~3 tests):
- `test_rebase_linear`: Rebase feature onto updated main, compare history
- `test_rebase_conflict_abort`: Rebase hits conflict, abort, verify clean state
- `test_rebase_onto`: Rebase --onto, compare resulting graph

**Stash** (~3 tests):
- `test_stash_push_pop_roundtrip`: Stash changes, pop, compare working tree
- `test_stash_list_output`: Multiple stashes, list output matches
- `test_stash_with_untracked`: Stash --include-untracked, compare behavior

**Cherry-pick and revert** (~3 tests):
- `test_cherry_pick_output_matches`: Cherry-pick commit, compare output and tree
- `test_revert_output_matches`: Revert commit, compare output and tree
- `test_cherry_pick_conflict`: Cherry-pick with conflict, compare markers

**Tags** (~3 tests):
- `test_annotated_tag_interop`: Create annotated tag, compare cat-file -p output
- `test_tag_list_output_matches`: List tags, compare output
- `test_tag_verify_cross_tool`: Tag created by gitr, verified by C git describe

**Maintenance** (~2 tests):
- `test_gc_repack_packfile_compat`: Gitr gc, C git can read resulting packfile
- `test_fsck_after_repack`: Repack with gitr, fsck with C git

### Phase F: E2E Edge Case Tests (P3)

`e2e_edge_case_tests.rs` — covers User Story 7:

**Binary files** (~3 tests):
- `test_binary_file_add_commit_show`: Binary content roundtrips correctly
- `test_binary_diff_markers`: Diff shows "Binary files differ" identically
- `test_binary_cat_file_identical`: cat-file -p on binary blob matches

**Empty and degenerate repos** (~3 tests):
- `test_empty_repo_status`: Status on empty repo (no commits) matches
- `test_empty_repo_log`: Log on empty repo produces matching error/output
- `test_empty_commit`: Commit with --allow-empty, compare behavior

**Unicode and special paths** (~3 tests):
- `test_unicode_filename_roundtrip`: Add/commit/ls-files with unicode filenames
- `test_space_in_filename`: Filenames with spaces handled identically
- `test_special_chars_in_path`: Filenames with quotes, brackets, etc.

**Nested structures** (~2 tests):
- `test_deeply_nested_dirs`: 10+ levels of nesting, ls-tree -r output matches
- `test_many_files_in_directory`: 100+ files in one dir, ls-files output matches

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Some gitr commands have incomplete implementations | High | Medium | Use `#[ignore]` for known gaps, document in test comments |
| CI git version differs from local, causing output differences | Medium | High | Pin environment thoroughly (locale, TZ, config), use `git -c` overrides where needed |
| Parallel test execution causes temp dir conflicts | Low | Medium | Each test uses independent `tempfile::tempdir()` |
| Refactoring existing tests introduces regressions | Low | High | Run full test suite after Phase B, compare test count |
| Merge conflict output format varies by git version | Medium | Medium | Normalize conflict markers if needed, document minimum git version |
