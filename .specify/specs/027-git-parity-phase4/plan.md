# Implementation Plan: Git Parity Phase 4 — Remaining Behavioral Gaps

**Branch**: `027-git-parity-phase4` | **Date**: 2026-02-09 | **Spec**: `specs/027-git-parity-phase4/spec.md`
**Input**: Feature specification from `.specify/specs/027-git-parity-phase4/spec.md`

## Summary

Complete all remaining git behavioral parity gaps: implement 9 no-op flags (log --follow, --left-right, --cherry-pick, --cherry-mark, --ancestry-path, --source; diff --no-index, --check; pull --rebase), 9 stub subcommands (5 remote subcommands, 2 reflog subcommands, 2 maintenance subcommands), 7 interactive patch modes (add/reset/checkout/restore/stash -p, clean -i, rebase -i), and fix 3 incomplete core engines (subtree merge shift, octopus 3+ heads, sequencer abort). Implementation spans git-revwalk (walk filters, cherry equivalence), git-merge (subtree/octopus strategies, sequencer abort), git-diff (no-index/check modes), git-ref (reflog expire/delete), and git-cli (all command integrations + interactive modes).

## Technical Context

**Language/Version**: Rust 1.75+ (Cargo workspace, 19 crates)
**Primary Dependencies**: clap 4 (CLI), bstr 1 (byte strings), sha1/sha2 0.10 (hashing), flate2 1 (zlib), memmap2 0.9 (packfile), crc32fast 1 (pack index), thiserror 2 / anyhow 1 (errors), rayon 1 (parallelism), regex 1 (grep/pickaxe), tempfile 3 (test isolation)
**Storage**: Git on-disk format (loose objects, packfiles v2, refs, index, config, reflog, attributes, mailmap) — all file-based
**Testing**: cargo test (unit + integration), E2E interop tests comparing gitr vs git byte-identical output
**Target Platform**: macOS (launchd for maintenance), Linux (cron/systemd for maintenance)
**Project Type**: Single Cargo workspace — 19 library/binary crates
**Performance Goals**: Output parity with git; interactive modes responsive at TTY speeds
**Constraints**: No panics in library code; all public APIs return Result<T, E>; zero regressions in existing tests
**Scale/Scope**: 28 items across 5 user stories; ~15 files modified, ~3000-5000 lines added

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Safety-First | PASS | All new code returns Result<T,E>; no unsafe needed; RAII for file handles; bounds-checked byte buffers |
| II. C-Compatibility | PASS | Primary goal of this spec — implementing missing features to match git byte-identical output |
| III. Modular Crates | PASS | Work distributed across existing crates (git-revwalk, git-merge, git-diff, git-ref, git-cli); no new crate needed; crate dependencies follow existing DAG |
| IV. Trait-Based Abstraction | PASS | MergeStrategy trait already exists for subtree/octopus; no new trait-breaking changes |
| V. Test-Driven | PASS | Spec defines acceptance scenarios; E2E interop tests validate output parity; unit tests for each new module |
| Error Handling | PASS | thiserror in library crates, anyhow in CLI binary |
| Performance | PASS | No hot-path changes; interactive modes bound by user input speed |
| Byte String Handling | PASS | Existing bstr usage continues for file paths |
| Serialization | PASS | No new on-disk formats; reflog/sequencer use existing formats |

**Gate result**: PASS — no violations.

## Project Structure

### Documentation (this feature)

```text
specs/027-git-parity-phase4/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
crates/
├── git-revwalk/src/
│   ├── lib.rs               # Add left_right, cherry_mark, ancestry_path, source to walk options
│   ├── cherry.rs            # Extend cherry equivalence for cherry_pick/cherry_mark
│   ├── walk.rs              # Add ancestry_path filtering, source tracking during traversal
│   └── format.rs            # Left-right prefix rendering (</>), cherry-mark (=,+), source annotation
├── git-merge/src/
│   ├── strategy/subtree.rs  # Implement subtree shift detection and path adjustment
│   ├── strategy/octopus.rs  # Implement iterative 3+ head merge with conflict abort
│   └── sequencer.rs         # Fix abort() to restore HEAD/index from saved state
├── git-diff/src/
│   └── lib.rs (or check.rs) # Add whitespace check mode (trailing WS, mixed tabs, blank EOF)
├── git-ref/src/
│   └── reflog.rs            # Add expire() and delete() methods for reflog entries
├── git-cli/src/
│   ├── interactive.rs       # Complete manual hunk edit (e), integrate with commands
│   ├── commands/log.rs      # Wire follow, left_right, cherry_pick, cherry_mark, ancestry_path, source
│   ├── commands/diff.rs     # Implement --no-index (non-repo diff), --check (whitespace errors)
│   ├── commands/pull.rs     # Implement --rebase (fetch + rebase instead of merge)
│   ├── commands/remote.rs   # Implement set-head, prune, update, set-branches, get-url
│   ├── commands/reflog.rs   # Implement expire, delete
│   ├── commands/maintenance.rs  # Implement start (launchd/cron), stop
│   ├── commands/add.rs      # Integrate interactive.rs for -p flag
│   ├── commands/reset.rs    # Integrate interactive.rs for -p flag
│   ├── commands/checkout.rs # Integrate interactive.rs for -p flag
│   ├── commands/restore.rs  # Integrate interactive.rs for -p flag
│   ├── commands/stash.rs    # Integrate interactive.rs for -p flag
│   ├── commands/clean.rs    # Implement -i interactive menu
│   └── commands/rebase.rs   # Implement -i interactive rebase (todo list, all actions)
└── tests/
    └── (E2E interop tests for all 28 items)
```

**Structure Decision**: Single Cargo workspace; all changes within existing crate boundaries. No new crates needed. The git-cli crate contains all command handlers and the interactive module. Library logic lives in git-revwalk (walk filters), git-merge (strategies, sequencer), git-diff (check mode), and git-ref (reflog management).

## Complexity Tracking

> No constitution violations — table not needed.
